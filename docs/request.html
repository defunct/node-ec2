<!DOCTYPE html>  <html> <head>   <title>request.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               request.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-1">#</a>               </div>               <p>Require Node.js core modules.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">crypto</span>          <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;crypto&quot;</span><span class="p">)</span>
<span class="nx">http</span>            <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;http&quot;</span><span class="p">)</span>
<span class="nx">querystring</span>     <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;querystring&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-2">#</a>               </div>               <p>Oh, how I miss you sprintf.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">pad</span> <span class="o">=</span> <span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">:</span> <span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-3">#</a>               </div>               <p>Generate a UTC timestamp in <a href="http://en.wikipedia.org/wiki/ISO_8601">ISO 8601</a>
for the Amazon Query API request. The Amazon Query API will respond with an
error if the timestamp of the request is not in the last twenty minutes or so.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">timestamp</span> <span class="o">=</span> <span class="p">()</span> <span class="o">-&gt;</span>
  <span class="nx">now</span>       <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
  <span class="nx">year</span>      <span class="o">=</span> <span class="nx">now</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span>
  <span class="nx">month</span>     <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getUTCMonth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
  <span class="nx">day</span>       <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">())</span>
  <span class="nx">hours</span>     <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">())</span>
  <span class="nx">minutes</span>   <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">now</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">())</span>
  <span class="s2">&quot;#{year}-#{month}-#{day}T#{hours}:#{minutes}:00Z&quot;</span>

<span class="nx">invoke</span> <span class="o">=</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="nx">command</span><span class="p">,</span> <span class="nx">parameters</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-4">#</a>               </div>               <p>The parameters common to all Amazon Query API requests as documented in
<a href="http://docs.amazonwebservices.com/AWSEC2/latest/DeveloperGuide/index.html?using-query-api.html">Making Query Requests</a>
in the Amazon Elastic Compute Cloud Developer Guide.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">map</span> <span class="o">=</span>
    <span class="nv">AWSAccessKeyId: </span><span class="nx">key</span>
    <span class="nv">Action: </span><span class="nx">command</span>
    <span class="nv">SignatureMethod: </span><span class="s2">&quot;HmacSHA256&quot;</span>
    <span class="nv">Timestamp: </span><span class="nx">timestamp</span><span class="p">()</span>
    <span class="nv">SignatureVersion: </span><span class="mi">2</span>
    <span class="nv">Version: </span><span class="s2">&quot;2010-06-15&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-5">#</a>               </div>               <p>Merge the request specific parameters with the common parameters.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">parameters</span>
    <span class="nx">map</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;function&#39;</span>
        <span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]()</span>
      <span class="k">else</span>
        <span class="nx">parameters</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-6">#</a>               </div>               <p>The Amazon Query API authenticates the request with Calculate an RFC
2104-compliant HMAC. We build a string to sign that includes the query
parameters ordered by the lexical order of the parameter names.</p>

<p>Here we sort the query parameter names and create an array of URL encoded
query name value pairs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">names</span> <span class="o">=</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">map</span>
    <span class="nx">key</span>
  <span class="nx">names</span><span class="p">.</span><span class="nx">sort</span>

  <span class="nx">query</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">names</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">querystring</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span> <span class="o">+</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">name</span><span class="p">]))</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-7">#</a>               </div>               <p>The string includes the request verb, server, request path and the query
string sorted by the lexical order of the parameter names.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">toSign</span> <span class="o">=</span> <span class="s2">&quot;GET\n&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;ec2.amazonaws.com\n&quot;</span> <span class="o">+</span>
    <span class="s2">&quot;/\n&quot;</span> <span class="o">+</span>
    <span class="nx">query</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-8">#</a>               </div>               <p>Generate the HMAC.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHmac</span> <span class="s2">&quot;sha256&quot;</span><span class="p">,</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">[</span><span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">]</span>
  <span class="nx">hmac</span><span class="p">.</span><span class="nx">update</span> <span class="nx">toSign</span>
  <span class="nx">digest</span> <span class="o">=</span> <span class="nx">querystring</span><span class="p">.</span><span class="nx">escape</span><span class="p">(</span><span class="nx">hmac</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-9">#</a>               </div>               <p>Add the HMAC to the query string.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">query</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;Signature=&quot;</span> <span class="o">+</span> <span class="nx">digest</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="octowrap">                 <a class="octothorpe" href="#section-10">#</a>               </div>               <p>Connect to the Amazon Query API server, gather the response, and feed it to
the callback function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">client</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createClient</span> <span class="mi">443</span><span class="p">,</span> <span class="s2">&quot;ec2.amazonaws.com&quot;</span><span class="p">,</span> <span class="kc">true</span>
  <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="nv">host: </span><span class="s2">&quot;ec2.amazonaws.com&quot;</span> <span class="p">}</span>
  <span class="nx">request</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nx">request</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/?&quot;</span> <span class="o">+</span> <span class="nx">query</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">),</span> <span class="nx">headers</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">end</span>
  <span class="nx">request</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">-&gt;</span>
    <span class="nx">body</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">setEncoding</span> <span class="s2">&quot;utf8&quot;</span>
    <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">-&gt;</span>
      <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span>
    <span class="nx">response</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="p">()</span> <span class="o">-&gt;</span>
      <span class="nx">callback</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">invoke</span> <span class="o">=</span> <span class="nx">invoke</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 